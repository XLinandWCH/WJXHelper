<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学生婚育观调查结果可视化 (多图表)</title>
    <!-- 引入 html2canvas 库用于截图下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 引入 Chart.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 全局样式 (与之前类似，可根据需要调整) --- */
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }

        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .chart-container {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            position: relative; /* 用于定位下载按钮 */
        }

        .chart-wrapper { /* 新增：用于包裹 canvas，控制大小 */
            position: relative;
            height: 300px; /* 默认高度，可按需调整 */
            width: 100%;
        }
        .chart-wrapper.small-chart { /* 针对选项少的饼图 */
             height: 250px;
        }
        .chart-wrapper.horizontal-bar-chart { /* 水平条形图可能需要更高的高度 */
            height: auto; /* 高度由内容决定 */
            min-height: 200px;
        }


        .download-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            z-index: 10; /*确保在canvas之上*/
        }

        .download-btn:hover {
            background-color: #2980b9;
        }

        /* --- 词云图样式 (与之前相同) --- */
        .word-cloud {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 200px;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .word-cloud span {
            margin: 5px 8px;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: default;
            transition: transform 0.2s ease;
        }
        .word-cloud span:hover{
            transform: scale(1.1);
        }

        .total-respondents {
            text-align: right;
            font-style: italic;
            color: #777;
            margin-top: 10px;
            font-size: 13px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>智能算法视域下的新媒体平台对当代大学生婚育观的隐性规训研究 - 可视化报告 (多图表)</h1>

        <div id="charts-area">
            <!-- 问题1: 性别 (环状图) -->
            <div class="chart-container" id="chart-q1-container">
                <h2>1. 您的性别: [单选题]</h2>
                <div class="chart-wrapper small-chart"><canvas id="chart-q1-canvas"></canvas></div>
                <div class="total-respondents" id="total-q1"></div>
                <button class="download-btn" onclick="downloadChart('chart-q1-container', '性别分布')">下载图表</button>
            </div>

            <!-- 问题2: 年级 (柱状图) -->
            <div class="chart-container" id="chart-q2-container">
                <h2>2. 您所在的年级: [单选题]</h2>
                <div class="chart-wrapper"><canvas id="chart-q2-canvas"></canvas></div>
                <div class="total-respondents" id="total-q2"></div>
                <button class="download-btn" onclick="downloadChart('chart-q2-container', '年级分布')">下载图表</button>
            </div>

            <!-- 问题3: 专业类别 (水平条形图) -->
            <div class="chart-container" id="chart-q3-container">
                <h2>3. 您的专业类别: [单选题]</h2>
                <div class="chart-wrapper horizontal-bar-chart"><canvas id="chart-q3-canvas"></canvas></div>
                <div class="total-respondents" id="total-q3"></div>
                <button class="download-btn" onclick="downloadChart('chart-q3-container', '专业类别分布')">下载图表</button>
            </div>

            <!-- 问题4: 生源地 (柱状图) -->
            <div class="chart-container" id="chart-q4-container">
                <h2>4. 您的生源地: [单选题]</h2>
                <div class="chart-wrapper"><canvas id="chart-q4-canvas"></canvas></div>
                <div class="total-respondents" id="total-q4"></div>
                <button class="download-btn" onclick="downloadChart('chart-q4-container', '生源地分布')">下载图表</button>
            </div>

            <!-- 问题5: 是否独生子女 (环状图) -->
            <div class="chart-container" id="chart-q5-container">
                <h2>5. 是否为独生子女: [单选题]</h2>
                <div class="chart-wrapper small-chart"><canvas id="chart-q5-canvas"></canvas></div>
                <div class="total-respondents" id="total-q5"></div>
                <button class="download-btn" onclick="downloadChart('chart-q5-container', '是否独生子女')">下载图表</button>
            </div>

            <!-- 问题6: 日常使用的新媒体平台 (水平条形图) -->
            <div class="chart-container" id="chart-q6-container">
                <h2>6. 您日常使用的新媒体平台有 (可多选): [多选题]</h2>
                <div class="chart-wrapper horizontal-bar-chart" style="height: 350px;"><canvas id="chart-q6-canvas"></canvas></div>
                <div class="total-respondents" id="total-q6"></div>
                <button class="download-btn" onclick="downloadChart('chart-q6-container', '新媒体平台使用')">下载图表</button>
            </div>

            <!-- 问题7: 每日使用时长 (柱状图) -->
            <div class="chart-container" id="chart-q7-container">
                <h2>7. 您每天使用新媒体平台的总时长约为: [单选题]</h2>
                <div class="chart-wrapper"><canvas id="chart-q7-canvas"></canvas></div>
                <div class="total-respondents" id="total-q7"></div>
                <button class="download-btn" onclick="downloadChart('chart-q7-container', '每日使用时长')">下载图表</button>
            </div>

            <!-- 问题12: 接触婚育内容频率 (折线图) - 示例折线图 -->
            <div class="chart-container" id="chart-q12-container">
                <h2>12. 您平均每周主动搜索或被动接收婚育相关内容的频率是: [单选题]</h2>
                <div class="chart-wrapper"><canvas id="chart-q12-canvas"></canvas></div>
                <div class="total-respondents" id="total-q12"></div>
                <button class="download-btn" onclick="downloadChart('chart-q12-container', '接触婚育内容频率')">下载图表</button>
            </div>

            <!-- 更多图表容器... (为了简洁，这里省略了所有问题的HTML结构，请参照上面模式添加) -->

            <!-- 问题29: 故事完成法1 - 词云 -->
            <div class="chart-container" id="chart-q29-container">
                <h2>29. 故事完成法 1: ... [填空题 - 词云展示]</h2>
                <div class="word-cloud" id="wordcloud-q29"></div>
                <button class="download-btn" onclick="downloadChart('chart-q29-container', '故事完成法1词云')">下载图表</button>
            </div>

            <!-- 问题31: 文字联想1 - 词云 -->
            <div class="chart-container" id="chart-q31-container">
                <h2>31. 文字联想 1: ... [填空题 - 词云展示]</h2>
                <div class="word-cloud" id="wordcloud-q31"></div>
                <button class="download-btn" onclick="downloadChart('chart-q31-container', '智能算法联想词云')">下载图表</button>
            </div>

            <!-- 问题32: 文字联想2 - 词云 -->
            <div class="chart-container" id="chart-q32-container">
                <h2>32. 文字联想 2: ... [填空题 - 词云展示]</h2>
                <div class="word-cloud" id="wordcloud-q32"></div>
                <button class="download-btn" onclick="downloadChart('chart-q32-container', '新媒体婚姻案例联想词云')">下载图表</button>
            </div>

        </div>
    </div>

    <script>
        // --- 调查数据 (与之前相同，这里只保留部分用于示例) ---
        const surveyData = {
            q1: { total: 2350, options: [{ label: "男", count: 1146, percentage: "48.77%" }, { label: "女", count: 1204, percentage: "51.23%" }] },
            q2: { total: 2350, options: [{ label: "大一", count: 338, percentage: "14.38%" }, { label: "大二", count: 571, percentage: "24.3%" }, { label: "大三", count: 985, percentage: "41.91%" }, { label: "大四", count: 317, percentage: "13.49%" }, { label: "研究生及以上", count: 139, percentage: "5.91%" }] },
            q3: { total: 2350, options: [{ label: "文科", count: 830, percentage: "35.32%" }, { label: "理科", count: 556, percentage: "23.66%" }, { label: "工科", count: 814, percentage: "34.64%" }, { label: "艺术/体育", count: 150, percentage: "6.38%" }]},
            q4: { total: 2350, options: [ { label: "一线城市", count: 118, percentage: "5.02%" }, { label: "二线城市", count: 300, percentage: "12.77%" }, { label: "三四线城市", count: 593, percentage: "25.23%" }, { label: "县城/乡镇", count: 649, percentage: "27.62%" }, { label: "农村", count: 690, percentage: "29.36%" }]},
            q5: { total: 2350, options: [{ label: "是", count: 450, percentage: "19.15%" }, { label: "否", count: 1900, percentage: "80.85%" }]},
            q6: { total: 2350, options: [ { label: "抖音", count: 1867, percentage: "79.45%" }, { label: "微博", count: 939, percentage: "39.96%" }, { label: "微信(朋友圈/公众号)", count: 2113, percentage: "89.91%" }, { label: "B站", count: 1392, percentage: "59.23%" }, { label: "小红书", count: 1575, percentage: "67.02%" }, { label: "知乎", count: 719, percentage: "30.6%" }, { label: "快手", count: 1648, percentage: "70.13%" }, { label: "淘宝/京东(含直播)", count: 1392, percentage: "59.23%" }]},
            q7: { total: 2350, options: [ { label: "<1 小时", count: 4, percentage: "0.17%" }, { label: "1-2 小时", count: 169, percentage: "7.19%" }, { label: "2-3 小时", count: 215, percentage: "9.15%" }, { label: "3-4 小时", count: 532, percentage: "22.64%" }, { label: "4小时以上", count: 1430, percentage: "60.85%" }]},
            q12: { total: 2350, options: [ { label: "几乎没有", count: 1874, percentage: "79.74%" }, { label: "1-2次", count: 230, percentage: "9.79%" }, { label: "3-5次", count: 241, percentage: "10.26%" }, { label: "5次以上", count: 5, percentage: "0.21%" }]},
            // ... (此处省略了q8-q11, q13-q28的数据，请从上一个回答中完整复制过来)
            wordCloudQ29: [ { text: "不看", size: 30 }, { text: "荒谬", size: 20 }, { text: "不感兴趣", size: 28 }, { text: "焦虑", size: 15 }, { text: "无所谓", size: 25 }, { text: "结婚", size: 22 }, { text: "30岁", size: 18 }, { text: "封建", size: 16 }, { text: "个人选择", size: 26 }, { text: "忽略", size: 24 }, { text: "压力", size: 19 }, { text: "反感", size: 27 } ],
            wordCloudQ31: [ { text: "信息茧房", size: 35 }, { text: "精准营销", size: 30 }, { text: "大数据", size: 28 }, { text: "个性化", size: 25 }, { text: "推荐", size: 22 }, { text: "隐私", size: 20 }, { text: "AI", size: 18 }, { text: "猜你喜欢", size: 26 }, { text: "算法", size: 15 }, { text: "控制", size: 17 }, { text: "数据分析", size: 23 } ],
            wordCloudQ32: [ { text: "婚礼", size: 30 }, { text: "网红", size: 28 }, { text: "直播求婚", size: 25 }, { text: "秀恩爱", size: 22 }, { text: "分手", size: 18 }, { text: "炒作", size: 20 }, { text: "离婚", size: 16 }, { text: "Vlog", size: 26 }, { text: "甜宠", size: 15 }, { text: "剧本", size: 19 }, { text: "不真实", size: 24 } ]
        };

        // --- Chart.js 辅助函数和颜色 ---
        const chartColors = [ // 一些预设颜色
            'rgba(54, 162, 235, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(75, 192, 192, 0.8)',
            'rgba(255, 206, 86, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
            'rgba(199, 199, 199, 0.8)', 'rgba(83, 102, 255, 0.8)', 'rgba(100, 255, 100, 0.8)'
        ];
        const chartBorderColors = chartColors.map(color => color.replace('0.8', '1'));


        /**
         * 创建 Chart.js 图表
         * @param {string} canvasId - canvas 元素的 ID
         * @param {string} chartType - Chart.js 图表类型 (e.g., 'bar', 'doughnut', 'line', 'pie', 'horizontalBar')
         * @param {Array} labels - 图表的标签数组
         * @param {Array} dataValues - 图表的数据值数组 (对应百分比)
         * @param {string} label - 数据集的标签
         * @param {Object} optionsOverride - 可选，覆盖默认 Chart.js 选项
         * @param {string} totalId - 显示总人数的元素ID
         * @param {number} totalRespondents - 总填写人次
         */
        function createGenericChart(canvasId, chartType, labels, dataValues, datasetLabel, optionsOverride = {}, totalId, totalRespondents) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // 为不同图表类型准备颜色
            let backgroundColors = chartColors.slice(0, dataValues.length);
            let borderColors = chartBorderColors.slice(0, dataValues.length);

            if (chartType === 'line') { // 折线图通常用一种主色
                backgroundColors = chartColors[0].replace('0.8', '0.2'); // 填充区域颜色淡一点
                borderColors = chartBorderColors[0];
            } else if (chartType === 'bar' || chartType === 'horizontalBar') { // 柱状图/条形图可以用同一种颜色或多种
                 // backgroundColors = chartColors[0]; // 如果想所有柱子同色
                 // borderColors = chartBorderColors[0];
            }


            const data = {
                labels: labels,
                datasets: [{
                    label: datasetLabel || '百分比',
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    fill: chartType === 'line' ? true : false, // 折线图可填充下方区域
                    tension: chartType === 'line' ? 0.1 : 0 // 折线图曲线平滑度
                }]
            };

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false, // 重要，允许 chart-wrapper 控制大小
                plugins: {
                    legend: {
                        position: (chartType === 'doughnut' || chartType === 'pie') ? 'top' : 'none', // 饼图/环形图显示图例
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null && (chartType === 'bar' || chartType === 'line')) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                } else if (context.parsed !== null && (chartType === 'doughnut' || chartType === 'pie')) {
                                     label += context.parsed.toFixed(2) + '%';
                                } else if (context.parsed.x !== null && chartType === 'horizontalBar') {
                                    label += context.parsed.x.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    },
                    title: { // 可以给图表添加主标题
                        display: false, // 默认不显示，如果需要可以设为true
                        text: datasetLabel
                    }
                },
                scales: { // 坐标轴设置
                    y: {
                        beginAtZero: true,
                        display: (chartType !== 'doughnut' && chartType !== 'pie' && chartType !== 'horizontalBar'), // 饼图/环形图/水平条形图不需要y轴
                        ticks: {
                            callback: function(value) { return value + "%" } // y轴刻度加百分号
                        },
                        title: {
                            display: false, // (chartType === 'bar' || chartType === 'line'),
                            text: '百分比 (%)'
                        }
                    },
                    x: {
                        display: (chartType !== 'doughnut' && chartType !== 'pie'), // 饼图/环形图不需要x轴
                        title: {
                            display: false,
                            text: '选项'
                        },
                        ticks: {
                             callback: function(value, index, ticks) {
                                if (chartType === 'horizontalBar') return this.getLabelForValue(value) + "%"; // 水平条形图x轴刻度加百分号
                                return this.getLabelForValue(value); // 其他情况正常显示标签
                            }
                        }
                    }
                }
            };
            // 对于水平条形图，x和y轴的配置需要交换
            if (chartType === 'horizontalBar') {
                defaultOptions.indexAxis = 'y'; // 将y轴作为索引轴
                defaultOptions.scales.y.display = true; // 水平条形图需要y轴显示标签
                defaultOptions.scales.y.ticks.callback = function(value) { return this.getLabelForValue(value); }; // y轴显示选项标签
                defaultOptions.scales.y.title.display = false;

                defaultOptions.scales.x.display = true; // 水平条形图需要x轴显示百分比
                defaultOptions.scales.x.ticks.callback = function(value) { return value + "%"; };
                defaultOptions.scales.x.title.display = false; // text: '百分比 (%)'
            }


            new Chart(ctx, {
                type: chartType,
                data: data,
                options: { ...defaultOptions, ...optionsOverride }
            });

            const totalElement = document.getElementById(totalId);
            if (totalElement) {
                 totalElement.textContent = `本题有效填写人次: ${totalRespondents}`;
            }
        }


        // --- 词云图函数 (与之前相同) ---
        function createWordCloud(cloudId, wordsData) {
            const cloudContainer = document.getElementById(cloudId);
            cloudContainer.innerHTML = '';
            const colors = ['#2980b9', '#27ae60', '#f39c12', '#8e44ad', '#c0392b', '#16a085', '#d35400'];
            const minFontSize = 12, maxFontSize = 36;
            let maxSize = 0, minSize = Infinity;
            wordsData.forEach(word => {
                if (word.size > maxSize) maxSize = word.size;
                if (word.size < minSize) minSize = word.size;
            });
            if (maxSize === minSize) minSize = maxSize -1;

            wordsData.forEach((word, index) => {
                const wordSpan = document.createElement('span');
                wordSpan.textContent = word.text;
                let fontSize = minFontSize;
                if (maxSize > minSize) {
                    fontSize = minFontSize + ( (word.size - minSize) / (maxSize - minSize) ) * (maxFontSize - minFontSize);
                } else if (wordsData.length > 0) {
                     fontSize = (minFontSize + maxFontSize) / 2;
                }
                wordSpan.style.fontSize = Math.max(minFontSize, Math.min(maxFontSize, fontSize)) + 'px';
                wordSpan.style.color = '#fff';
                wordSpan.style.backgroundColor = colors[index % colors.length];
                wordSpan.style.fontWeight = (word.size > (maxSize + minSize) / 2 * 0.8) ? 'bold' : 'normal';
                cloudContainer.appendChild(wordSpan);
            });
        }

        // --- 下载图表函数 (与之前相同) ---
        window.downloadChart = function(elementId, filename) {
            const elementToCapture = document.getElementById(elementId);
            if (!elementToCapture) { console.error("Element not found:", elementId); return; }
            const downloadButton = elementToCapture.querySelector('.download-btn');
            let originalDisplay = '';
            if(downloadButton) { originalDisplay = downloadButton.style.display; downloadButton.style.display = 'none'; }

            html2canvas(elementToCapture, { useCORS: true, scale: 2, backgroundColor: '#f9f9f9' })
            .then(canvas => {
                const image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                const link = document.createElement('a');
                link.download = (filename || 'chart') + '.png';
                link.href = image;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                if(downloadButton) { downloadButton.style.display = originalDisplay; }
            }).catch(err => {
                console.error("Error during html2canvas:", err);
                if(downloadButton) { downloadButton.style.display = originalDisplay; }
            });
        }

        // --- 页面加载时生成所有图表 ---
        document.addEventListener('DOMContentLoaded', () => {
            // Q1: 性别 - 环状图 (Doughnut)
            const q1Labels = surveyData.q1.options.map(item => item.label);
            const q1Data = surveyData.q1.options.map(item => parseFloat(item.percentage));
            createGenericChart('chart-q1-canvas', 'doughnut', q1Labels, q1Data, '性别分布', {}, 'total-q1', surveyData.q1.total);

            // Q2: 年级 - 柱状图 (Bar)
            const q2Labels = surveyData.q2.options.map(item => item.label);
            const q2Data = surveyData.q2.options.map(item => parseFloat(item.percentage));
            createGenericChart('chart-q2-canvas', 'bar', q2Labels, q2Data, '年级分布', { plugins: { legend: { display: false } } }, 'total-q2', surveyData.q2.total);

            // Q3: 专业类别 - 水平条形图 (horizontalBar)
            const q3Labels = surveyData.q3.options.map(item => item.label);
            const q3Data = surveyData.q3.options.map(item => parseFloat(item.percentage));
            // Chart.js v3+ uses 'bar' with indexAxis: 'y' for horizontal bars
            createGenericChart('chart-q3-canvas', 'bar', q3Labels, q3Data, '专业类别', { indexAxis: 'y', plugins: { legend: { display: false } } }, 'total-q3', surveyData.q3.total);

            // Q4: 生源地 - 柱状图 (Bar)
            const q4Labels = surveyData.q4.options.map(item => item.label);
            const q4Data = surveyData.q4.options.map(item => parseFloat(item.percentage));
            createGenericChart('chart-q4-canvas', 'bar', q4Labels, q4Data, '生源地分布', { plugins: { legend: { display: false } } }, 'total-q4', surveyData.q4.total);

            // Q5: 是否独生子女 - 环状图 (Doughnut)
            const q5Labels = surveyData.q5.options.map(item => item.label);
            const q5Data = surveyData.q5.options.map(item => parseFloat(item.percentage));
            createGenericChart('chart-q5-canvas', 'doughnut', q5Labels, q5Data, '是否独生子女', {}, 'total-q5', surveyData.q5.total);

            // Q6: 新媒体平台 - 水平条形图
            const q6Labels = surveyData.q6.options.map(item => item.label);
            const q6Data = surveyData.q6.options.map(item => parseFloat(item.percentage));
            createGenericChart('chart-q6-canvas', 'bar', q6Labels, q6Data, '新媒体平台使用频率', { indexAxis: 'y', plugins: { legend: { display: false } } }, 'total-q6', surveyData.q6.total);

            // Q7: 每日使用时长 - 柱状图
            const q7Labels = surveyData.q7.options.map(item => item.label);
            const q7Data = surveyData.q7.options.map(item => parseFloat(item.percentage));
            createGenericChart('chart-q7-canvas', 'bar', q7Labels, q7Data, '每日使用时长', { plugins: { legend: { display: false } } }, 'total-q7', surveyData.q7.total);

            // Q12: 接触婚育内容频率 - 折线图 (Line)
            const q12Labels = surveyData.q12.options.map(item => item.label);
            const q12Data = surveyData.q12.options.map(item => parseFloat(item.percentage));
            createGenericChart('chart-q12-canvas', 'line', q12Labels, q12Data, '接触频率', { plugins: { legend: { display: false } } }, 'total-q12', surveyData.q12.total);

            // ... 在这里为其他问题添加图表生成代码，选择合适的图表类型 ...
            // 例如:
            // Q24: 生育是否婚姻必要组成部分 - 饼图 (Pie)
            // const q24Labels = surveyData.q24.options.map(item => item.label);
            // const q24Data = surveyData.q24.options.map(item => parseFloat(item.percentage));
            // createGenericChart('chart-q24-canvas', 'pie', q24Labels, q24Data, '生育是否必要', {}, 'total-q24', surveyData.q24.total);


            // 生成词云图 (与之前相同)
            createWordCloud('wordcloud-q29', surveyData.wordCloudQ29);
            createWordCloud('wordcloud-q31', surveyData.wordCloudQ31);
            createWordCloud('wordcloud-q32', surveyData.wordCloudQ32);
        });
    </script>
</body>
</html>